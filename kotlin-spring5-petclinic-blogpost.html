
<p>I wanted to get my hands dirty with Kotlin and Spring 5 so I decided to develop a small application called PetClinic.</p>


<h3>PetClinic</h3>
<p>The application is a bookkeeping application for a pet clinic.
    The idea is you have owners who bring their pets for a visit to the pet clinic. The original idea
came from
<ul>
    <li>https://github.com/spring-projects/spring-petclinic</li>
    <li>https://github.com/spring-petclinic/spring-framework-petclinic</li>
</ul>
</p>

<h3>Why Kotlin?</h3>
<p>I love Java but Kotlin has a bunch of nice features that Java just doesn't at the moment.
You can check some of the features <a href="https://kotlinlang.org/docs/reference/">here</a>.
    You can also check my slides from a brown bag session I recently did.</p>

<iframe src="//www.slideshare.net/slideshow/embed_code/key/FgUXL988xQQbRO"
        width="595" height="485"
        frameborder="0" marginwidth="0"
        marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;"
        allowfullscreen>
</iframe>

<h3>kotlin-spring plugin + no-arg plugin</h3>
<p>
    Kotlin classes and methods are final by default.
    Frameworks like Spring that use CGLIB need classes to be open, because they create proxies
    that dynamically extend classes for you.
</p>
<p>So, instead of explicitly adding the `open` keyword all over the place you can use
    the <b>kotlin-spring</b> plugin that makes classes annotated with
    specific annotation open (e.x. classes annotated with @Configuration or @Service).
    It seems that Spring already has integrated that so you don't have to.

</p>
<p>
    The <b>no-arg</b> plugin generates a zero-argument constructor for classes
    with a specific annotation. That constructor is not directly accessible but you can use
    reflection to access it. This allows JPA or (in this case) Spring Data MongoDB
    to instantiate the data class.
</p>

<h3>The models</h3>
<p>Based on the idea that we frequently create a class that does nothing but hold data,
    data classes in Kotlin are special classes that the compile automatically derives
    getters/setters, equals, hashcode, toString, copy
    by adding the keyword `data`. Similar to what you can do with `@Data` annotation from
    <a href="https://projectlombok.org/">lombok</a> project. Data classes also support
    destructuring  (see below).


    <script src="https://gist.github.com/ssouris/e434365f9dc805bbf71ee785dcccdc2f.js"></script>

</p>

<h3>The repositories</h3>
<p>
I am using MongoDB with the reactive driver and this is how you can declare repositories
    using Spring Data MongoDB Reactive (ReactiveMongoRepository brings methods like insert, findAll etc)
More info <a href="http://docs.spring.io/spring-data/data-mongo/docs/2.0.0.M3/reference/html/#mongo.reactive.repositories">here</a>
</p>
<p>
    <script src="https://gist.github.com/ssouris/f4f0acf2ad871ca1e4aa954f5c024d13.js"></script>
</p>
<h3>Functional Web API</h3>
<p>
Spring 5 introduces the Functional Web API where you can declare your routes without using
    a DSL. Currently, you cannot mix functional API and annotation model (e.x. @RestController,
    @RequestMapping etc) in the same codebase.

</p>
<p>
    The two main classes in this API are `HandlerFunction`
</p>
<p>
    <script src="https://gist.github.com/ssouris/13b752ce78b48a78c376103caa5547b6.js"></script>
</p>
<p>
    that is the alternative of Servlet.service(..., ...) but is side effect free.
</p>
<p>
    <script src="https://gist.github.com/ssouris/7af93637c3735c2fd9295fad7f8b75cc.js"></script>
</p>
<p>

    Then the `RouterFunction` is the alternative of `@RequestMapping` annotation and
    routes the incoming requests to the appropriate handlers using RequestPredicate(s)
    you declare.
</p>
<p>
    <script src="https://gist.github.com/ssouris/40017bef48e2467a8de5254bb9f3093f.js"></script>
</p>
<p>
    ServerRequest and ServerResponse are immutable interfaces that offer access
    to the underlying HTTP messages.
    Typically, you do not write router functions yourself, but rather use
    `RouterFunctions.route(RequestPredicate, HandlerFunction)` to create one using a request
    predicate and handler function. If the predicate(s) applies, the request is routed to the
    given handler function, otherwise no routing is performed, resulting in a 404 Not Found response.
</p>
<p>
    This is how the Kotlin DSL looks like:
</p>
<p>
    <script src="https://gist.github.com/ssouris/e678a96aad6820c219466311a1808498.js"></script>

</p>

<h3>Kotlin lateinit in @Autowired fields</h3>

<p>It's worth noticing here the lateinit modifier. Kotlin assumes that a member is not null
    and that's why it must be assigned explicitly in the constructor. Since Spring Framework
    takes care of the autowiring after the constructor has run have to use lateinit
</p>
<p>
<script src="https://gist.github.com/ssouris/d7472fb4cd3e968e5a5ba2d5a04009d1.js"></script>
</p>

<h3>Extension methods</h3>

<p>Extension methods are really powerful in Kotlin and one of my favorite features. One
    use case for them in Java codebases can be in to replace all those Util classes (Util classes
    hell) with extension methods that seem more natural and readable. Here are a couple of extensions
    I wrote for this app. </p>
<p>
<script src="https://gist.github.com/ssouris/c708d57ce3589f2b9c5b72ae917f3d75.js"></script>
</p>

<h3>Extract Body using Flux, Mono</h3>
Spring 5 gives a variety of `BodyExtractors`, so that you can get the body as a Mono, a Flux
or even form data as multivalue map (Here I am transforming the multivalue map to sigle value map)
<p><script src="https://gist.github.com/ssouris/02d365dbc778f0c8bd74e8ad7f4d3282.js"></script></p>

<h3>Chaining Mono/Flux</h3>
In the following snippet I am trying to combine multiple Flux(es) to create a response
that Thymeleaf then renders in the server and sends to the browser.
I get the id query param, then query for the owner in the database, then after I know the owner
I query for the pets. Then in the final step, I am creating the map that Thymeleaf uses
to render the HTML.
<p><script src="https://gist.github.com/ssouris/c29c0d8dfee294ca7a01e295bc97b513.js"></script></p>

<h3>Kotlin Type Inference</h3>
<p>I also used a lot of automatic type inference in this project. For example:</p>
<p><script src="https://gist.github.com/ssouris/65fea29cea6a1131fed12bb97ac75fc2.js"></script></p>
<p>It can lead to less typing, increased readability and the famous one-liners.</p>

<h3>Attributions</h3>
<p>
    In this app the frontend (Thymeleaf) is not mine. I adapted it from
    <a href="https://github.com/cheptsov/kotlin-nosql-mongodb-petclinic/">https://github.com/cheptsov/kotlin-nosql-mongodb-petclinic/</a>.
</p>

<h3>Summary</h3>
<p>This post was packed with a lot things. And I was just enumerating things I used
while developing this application. Spring 5 new features are really neat and Kotlin is something
to keep an eye on and start using more frequently, it's interoperability with Java is
    just out of this world, making it possible to use it in Java codebases interchangeably.
    I really need at some point to stress test this application and compare it to the blocking equivalent,
    but that's a subject for another post.
    Thanks for reading and as always the code is
<a href="https://github.com/ssouris/petclinic-spring5-reactive">here</a></p>

<p>
    <h3>Links</h3>
<ul>
    <li>Mixit Reactive Spring 5 + Kotlin application: https://github.com/mixitconf/mixit</li>
    <li>Kotlin Spring 5 application: https://github.com/cheptsov/kotlin-nosql-mongodb-petclinic</li>
    <li>Kotlin reference: https://kotlinlang.org/docs/reference/</li>
</ul>
</p>